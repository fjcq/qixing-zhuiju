# 七星追剧 - 弹幕功能说明

## 弹幕功能介绍

七星追剧v1.2.0新增了实时弹幕功能，让观看同一视频的用户可以通过弹幕进行实时互动。支持两种弹幕模式：**实时弹幕**和**时间轴弹幕**。

## 弹幕模式说明

### 💬 实时弹幕模式（默认）

- **即时互动** - 弹幕发送后立即在所有观看者屏幕上显示
- **聊天室体验** - 类似直播间的实时聊天功能
- **不受视频进度影响** - 无论视频播放到什么位置，弹幕都会立即显示

### ⏰ 时间轴弹幕模式

- **时间同步** - 弹幕与视频播放时间绑定
- **重现体验** - 在相同的视频时间点显示相同的弹幕
- **历史记录** - 支持保存和回放历史弹幕内容

## 功能特点

### 🎯 核心功能

- **实时弹幕显示** - 支持多彩弹幕实时滚动显示
- **弹幕发送** - 支持用户发送自定义弹幕
- **房间系统** - 基于视频内容自动分配弹幕房间
- **多服务器支持** - 自动切换多个公共弹幕服务器

### 🎨 弹幕样式

- **多种颜色** - 白色、红色、黄色、绿色、青色、蓝色、紫色
- **三种大小** - 小、中、大三种字体尺寸
- **平滑动画** - 流畅的弹幕滚动效果
- **智能避让** - 多轨道显示，避免弹幕重叠

### 🔧 交互体验

- **快速输入** - 按回车键快速打开弹幕输入框
- **快捷发送** - 在输入框中按回车键或点击按钮发送弹幕
- **一键开关** - 播放器控制栏一键开启/关闭弹幕
- **本地标识** - 自己发送的弹幕带有绿色边框标识

## 使用方法

### 基本操作

1. **开启/关闭弹幕**
   - 点击播放器顶部控制栏的弹幕按钮（💬图标）
   - 按钮显示🚫表示弹幕已关闭

2. **切换弹幕模式**
   - 点击播放器顶部的模式切换按钮（💬/⏰图标）
   - 💬图标表示实时模式，⏰图标表示时间轴模式

3. **发送弹幕**
   - 按回车键打开弹幕输入框
   - 在输入框中输入弹幕内容（最多100字符）
   - 选择弹幕颜色和大小
   - 按回车键或点击"发送"按钮

4. **弹幕设置**
   - **颜色选择**：7种预设颜色可选
   - **大小调节**：小、中、大三种尺寸
   - **模式选择**：实时模式或时间轴模式
   - **设置保存**：弹幕开关状态和模式会自动保存

### 高级功能

1. **房间系统**
   - 系统根据视频名称和集数自动分配弹幕房间
   - 观看相同视频的用户会在同一个弹幕房间
   - 切换视频时自动切换弹幕房间

2. **服务器连接**
   - 自动连接多个公共WebSocket服务器
   - 连接失败时自动尝试下一个服务器
   - 支持断线重连机制

3. **性能优化**
   - 最多同时显示50条弹幕，超出自动清理
   - 10个弹幕轨道，智能分配避免重叠
   - 弹幕动画时长8秒，速度适中

## 快捷键说明

- **回车键** - 打开弹幕输入框
- **回车键**（在输入框内）- 发送弹幕
- **ESC键** - 关闭弹幕输入框
- **点击空白处** - 关闭弹幕输入框

## 技术实现

### 前端架构

- **WebSocket连接** - 使用原生WebSocket API连接公共服务器
- **CSS动画** - 使用CSS3动画实现平滑弹幕滚动
- **模块化设计** - 独立的弹幕系统模块，易于维护

### 数据格式

```javascript
// 弹幕消息格式
{
    type: 'danmaku',
    room: 'video_room_id',
    user: 'user_unique_id',
    text: '弹幕内容',
    color: '#ffffff',
    size: 'medium',
    time: 1625097600000
}
```

### 房间规则

- 房间ID生成规则：`${视频名称}_ep${集数}_${URL哈希}`
- 确保观看相同内容的用户在同一房间
- 支持多集、多线路的精确匹配

## 故障排除

### 常见问题

1. **弹幕无法显示**
   - 检查弹幕开关是否开启（💬按钮）
   - 确认网络连接正常
   - 尝试刷新播放器页面

2. **无法发送弹幕**
   - 检查输入内容是否超过100字符限制
   - 确认WebSocket连接状态
   - 尝试重新连接服务器

3. **弹幕卡顿或重叠**
   - 弹幕数量过多时系统会自动清理
   - 重启播放器可重置弹幕轨道
   - 调整弹幕大小可改善显示效果

### 网络问题

- 弹幕功能需要稳定的网络连接
- 防火墙可能阻止WebSocket连接
- 某些网络环境可能限制WebSocket协议

## 更新日志

## v1.2.0 (2025-01-03)

- 🆕 新增实时弹幕功能
- 🆕 支持多彩弹幕和尺寸调节
- 🆕 智能房间分配系统
- 🆕 多服务器自动切换
- 🔧 优化用户交互体验
- 🐛 修复弹幕轨道重叠问题

## 开发说明

### 弹幕系统架构

```text
DanmakuSystem (弹幕主类)
├── WebSocket连接管理
├── 弹幕渲染引擎
├── 轨道分配算法
├── 用户交互处理
└── 设置保存/加载
```

### 文件结构

- `src/renderer/js/danmaku.js` - 弹幕系统核心逻辑
- `src/renderer/css/player.css` - 弹幕相关样式（新增部分）
- `src/renderer/player.html` - 弹幕UI元素

### 集成方式

弹幕系统作为独立模块集成到播放器中：

1. 播放器初始化时创建弹幕系统
2. 播放视频时设置弹幕房间
3. 播放器销毁时清理弹幕资源

---

**注意事项**：

- 弹幕功能依赖网络连接，离线环境下无法使用
- 弹幕内容由用户自行发送，请文明使用
- 系统会自动过滤过长的弹幕内容（100字符限制）
