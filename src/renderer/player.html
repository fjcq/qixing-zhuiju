<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ƒæ˜Ÿè¿½å‰§ - æ’­æ”¾å™¨</title>
    <link rel="stylesheet" href="css/player.css">

    <!-- ç«‹å³æ‰§è¡Œçš„æµ‹è¯•è„šæœ¬ -->
    <script>
        console.log('ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ [PLAYER-HEAD] player.html HEAD è„šæœ¬ç«‹å³æ‰§è¡Œï¼ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥');
        console.log('[PLAYER-HEAD] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleTimeString());
        console.log('[PLAYER-HEAD] document.readyState:', document.readyState);
        console.log('[PLAYER-HEAD] window.location:', window.location.href);

        // æ·»åŠ ä¸€ä¸ªå…¨å±€æµ‹è¯•å‡½æ•°
        window.testPlayerLoaded = function () {
            console.log('ğŸ§ª [PLAYER-TEST] æ’­æ”¾å™¨é¡µé¢æµ‹è¯•å‡½æ•°è¢«è°ƒç”¨');
            return true;
        };

        // ç«‹å³æµ‹è¯•å…ƒç´ æŸ¥æ‰¾
        setTimeout(() => {
            console.log('ğŸ” [PLAYER-HEAD] å»¶è¿Ÿæµ‹è¯•DOMå…ƒç´ ...');
            const video = document.getElementById('video-player');
            const playBtn = document.getElementById('play-pause-btn');
            console.log('[PLAYER-HEAD] videoå…ƒç´ :', video ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°');
            console.log('[PLAYER-HEAD] æ’­æ”¾æŒ‰é’®:', playBtn ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°');
        }, 1000);
    </script>
</head>

<body>
    <!-- è‡ªå®šä¹‰æ ‡é¢˜æ  -->
    <div class="custom-titlebar">
        <div class="titlebar-drag-region">
            <span class="titlebar-title">ä¸ƒæ˜Ÿè¿½å‰§ - æ’­æ”¾å™¨</span>
        </div>
        <div class="titlebar-controls">
            <button class="titlebar-button minimize-btn" id="minimize-btn" title="æœ€å°åŒ–">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <path d="M0 6h12" stroke="currentColor" stroke-width="1" />
                </svg>
            </button>
            <button class="titlebar-button maximize-btn" id="maximize-btn" title="æœ€å¤§åŒ–/è¿˜åŸ">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <path d="M1 1h10v10H1z" fill="none" stroke="currentColor" stroke-width="1" />
                </svg>
            </button>
            <button class="titlebar-button close-btn" id="close-btn" title="å…³é—­">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <path d="M1 1l10 10M11 1L1 11" stroke="currentColor" stroke-width="1" />
                </svg>
            </button>
        </div>
    </div>

    <div id="player-app">
        <!-- æ’­æ”¾å™¨å®¹å™¨ - å…¨å±å¸ƒå±€ -->
        <div class="player-container">
            <video id="video-player" autoplay controlsList="nodownload nofullscreen noremoteplayback"
                preload="metadata">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
            </video>

            <!-- å¼¹å¹•å±‚ -->
            <div class="danmaku-container" id="danmaku-container"></div>

            <!-- æ‚¬æµ®æ§åˆ¶æ  -->
            <div class="player-overlay" id="player-overlay">
                <!-- å³ä¸Šè§’æ§åˆ¶æŒ‰é’® -->
                <div class="top-right-controls">
                    <button id="toggle-always-on-top" title="çª—å£ç½®é¡¶"
                        style="width: 32px; height: 32px; background: rgba(0, 0, 0, 0.7); border: none; border-radius: 6px; color: white; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 4px; backdrop-filter: blur(10px); transition: all 0.2s ease;">
                        ğŸ“Œ
                    </button>
                    <button id="cast-video" title="æŠ•å±åˆ°ç”µè§†"
                        style="width: 32px; height: 32px; background: rgba(0, 0, 0, 0.7); border: none; border-radius: 6px; color: white; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 4px; backdrop-filter: blur(10px); transition: all 0.2s ease;">
                        ğŸ“º
                    </button>
                    <button id="share-video" title="åˆ†äº«è§†é¢‘"
                        style="width: 32px; height: 32px; background: rgba(0, 0, 0, 0.7); border: none; border-radius: 6px; color: white; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 4px; backdrop-filter: blur(10px); transition: all 0.2s ease;">
                        ğŸ“¤
                    </button>
                </div>

                <!-- é¡¶éƒ¨æ§åˆ¶æ å·²éšè— - ä»…åœ¨å…¨å±æ—¶é€šè¿‡JSæ§åˆ¶æ˜¾ç¤º
                <div class="overlay-header">
                    <div class="video-info">
                        <h3 id="video-title">è§†é¢‘æ ‡é¢˜</h3>
                        <span id="video-episode">æ­£ç‰‡</span>
                    </div>
                    <div class="overlay-controls">
                        <button id="toggle-danmaku-header" class="btn-control" title="æ˜¾ç¤ºå¼¹å¹•è®¾ç½®é¢æ¿">
                            <span class="icon">âš™ï¸</span>
                        </button>
                        <button id="toggle-always-on-top-header" class="btn-control" title="çª—å£ç½®é¡¶">
                            <span class="icon">ğŸ“Œ</span>
                        </button>
                        <button id="cast-video-header" class="btn-control" title="æŠ•å±åˆ°ç”µè§†">
                            <span class="icon">ğŸ“º</span>
                        </button>
                        <button id="share-video-header" class="btn-control" title="åˆ†äº«æ­¤å‰§é›†ç»™å¥½å‹">
                            <span class="icon">ğŸ“¤</span>
                        </button>
                    </div>
                </div>
                -->

                <!-- åº•éƒ¨æ’­æ”¾æ§åˆ¶æ  -->
                <div class="overlay-footer">
                    <div class="playback-controls">
                        <!-- å·¦ä¾§æ’­æ”¾æ§åˆ¶ -->
                        <div class="playback-left">
                            <button id="play-pause-btn" class="btn-playback" title="æ’­æ”¾/æš‚åœ">
                                <span class="icon">â–¶ï¸</span>
                            </button>
                            <button id="prev-episode" class="btn-episode" disabled title="ä¸Šä¸€é›†">
                                <span class="icon">â®ï¸</span>
                            </button>
                            <button id="next-episode" class="btn-episode" title="ä¸‹ä¸€é›†">
                                <span class="icon">â­ï¸</span>
                            </button>
                            <div class="time-info">
                                <span id="current-time">00:00</span>
                                <span class="time-separator">/</span>
                                <span id="total-time">00:00</span>
                            </div>
                        </div>

                        <!-- ä¸­é—´è¿›åº¦æ¡ -->
                        <div class="progress-container">
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progress-bar">
                                    <div class="progress-fill" id="progress-fill"></div>
                                    <div class="progress-handle" id="progress-handle"></div>
                                </div>
                            </div>
                        </div>

                        <!-- å³ä¾§æ§åˆ¶ -->
                        <div class="playback-right">
                            <button id="toggle-episodes" class="btn-episode" title="æ˜¾ç¤º/éšè—é€‰é›†">
                                <span class="icon">ğŸ“‹</span>
                            </button>
                            <button id="toggle-danmaku" class="btn-episode" title="åˆ‡æ¢å¼¹å¹•">
                                <span class="icon">ğŸ’¬</span>
                            </button>
                            <button id="playback-speed" class="btn-episode" title="æ’­æ”¾é€Ÿåº¦">
                                <span class="icon">1.0x</span>
                            </button>
                            <div class="volume-control">
                                <button id="volume-btn" class="btn-volume" title="é™éŸ³/æ¢å¤">
                                    <span class="icon">ğŸ”Š</span>
                                </button>
                                <div class="volume-bar-container">
                                    <div class="volume-bar" id="volume-bar">
                                        <div class="volume-fill" id="volume-fill"></div>
                                        <div class="volume-handle" id="volume-handle"></div>
                                    </div>
                                </div>
                            </div>
                            <button id="fullscreen-btn" class="btn-fullscreen" title="å…¨å±/é€€å‡ºå…¨å±">
                                <span class="icon">â›¶</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¼¹å¹•è¾“å…¥åŒºåŸŸ -->
            <div class="danmaku-input-container hidden" id="danmaku-input-container">
                <div class="danmaku-input-panel">
                    <div class="danmaku-panel-header">
                        <span>å¼¹å¹•è®¾ç½®</span>
                        <button id="close-danmaku-panel" class="btn-close-panel" title="å…³é—­å¼¹å¹•é¢æ¿">
                            <span class="icon">âŒ</span>
                        </button>
                    </div>
                    <div class="danmaku-settings">
                        <div class="danmaku-toggle-group">
                            <label for="enable-danmaku">
                                <input type="checkbox" id="enable-danmaku" checked>
                                å¯ç”¨å¼¹å¹•æ˜¾ç¤º
                            </label>
                        </div>
                        <div class="danmaku-type-group">
                            <label>å¼¹å¹•ç±»å‹ï¼š</label>
                            <select id="danmaku-type" title="å¼¹å¹•ç±»å‹">
                                <option value="realtime">å®æ—¶å¼¹å¹•</option>
                                <option value="timeline">æ—¶é—´è½´å¼¹å¹•</option>
                            </select>
                        </div>
                    </div>
                    <input type="text" id="danmaku-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥å¼¹å¹•..." maxlength="100" />
                    <div class="danmaku-controls">
                        <select id="danmaku-color" title="å¼¹å¹•é¢œè‰²">
                            <option value="#ffffff">ç™½è‰²</option>
                            <option value="#ff0000">çº¢è‰²</option>
                            <option value="#ffff00">é»„è‰²</option>
                            <option value="#00ff00">ç»¿è‰²</option>
                            <option value="#00ffff">é’è‰²</option>
                            <option value="#0000ff">è“è‰²</option>
                            <option value="#ff00ff">ç´«è‰²</option>
                        </select>
                        <select id="danmaku-size" title="å¼¹å¹•å¤§å°">
                            <option value="small">å°</option>
                            <option value="medium" selected>ä¸­</option>
                            <option value="large">å¤§</option>
                        </select>
                        <button id="send-danmaku" class="btn-send" title="å‘é€å¼¹å¹•">å‘é€</button>
                    </div>
                </div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="player-loading" class="player-loading hidden">
                <div class="loading-spinner"></div>
                <p>è§†é¢‘åŠ è½½ä¸­...</p>
            </div>

            <!-- é”™è¯¯çŠ¶æ€ -->
            <div id="player-error" class="player-error hidden">
                <p id="error-message">è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>
                <div class="error-tips">
                    <p>ğŸ’¡ å»ºè®®ï¼š</p>
                    <ul>
                        <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                        <li>å°è¯•å…¶ä»–æ’­æ”¾çº¿è·¯</li>
                        <li>åˆ·æ–°é¡µé¢åé‡è¯•</li>
                    </ul>
                </div>
                <button id="retry-btn" class="btn-retry">é‡è¯•</button>
            </div>

            <!-- æŠ•å±è®¾å¤‡é€‰æ‹©å¯¹è¯æ¡† -->
            <div class="cast-device-modal" id="cast-device-modal">
                <div class="cast-modal-backdrop"></div>
                <div class="cast-modal-content">
                    <div class="cast-modal-header">
                        <h3>é€‰æ‹©æŠ•å±è®¾å¤‡</h3>
                        <button class="cast-modal-close" id="cast-modal-close">
                            <span class="icon">âŒ</span>
                        </button>
                    </div>

                    <div class="cast-modal-body">
                        <div class="cast-scanning" id="cast-scanning">
                            <div class="cast-spinner"></div>
                            <p>æ­£åœ¨æœç´¢å¯ç”¨è®¾å¤‡...</p>
                        </div>

                        <div class="cast-device-list" id="cast-device-list">
                            <!-- è®¾å¤‡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>

                        <div class="cast-no-devices" id="cast-no-devices" style="display: none;">
                            <div class="cast-no-devices-icon">ğŸ“º</div>
                            <p>æœªæ‰¾åˆ°å¯ç”¨çš„æŠ•å±è®¾å¤‡</p>
                            <div class="cast-tips">
                                <p>è¯·ç¡®ä¿ï¼š</p>
                                <ul>
                                    <li>è®¾å¤‡å’Œç”µè„‘åœ¨åŒä¸€ç½‘ç»œä¸‹</li>
                                    <li>æŠ•å±è®¾å¤‡å·²å¼€å¯æŠ•å±åŠŸèƒ½</li>
                                    <li>é˜²ç«å¢™å…è®¸ç›¸å…³ç«¯å£é€šä¿¡</li>
                                </ul>
                            </div>
                            <button class="btn-refresh-devices" id="btn-refresh-devices">
                                <span class="icon">ğŸ”„</span> é‡æ–°æœç´¢
                            </button>
                        </div>
                    </div>

                    <div class="cast-modal-footer">
                        <button class="btn-cancel" id="cast-cancel-btn">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- å¯æ”¶çº³çš„é€‰é›†åˆ—è¡¨ -->
            <div class="episode-panel" id="episode-panel">
                <div class="episode-panel-header">
                    <h4>æ’­æ”¾åˆ—è¡¨</h4>
                    <button id="close-episodes" class="btn-panel-close" title="å…³é—­é€‰é›†é¢æ¿">
                        <span class="icon">âŒ</span>
                    </button>
                </div>

                <!-- çº¿è·¯é€‰æ‹©åŒºåŸŸ -->
                <div class="route-selection" id="route-selection">
                    <div class="route-tabs" id="route-tabs"></div>
                </div>

                <!-- å‰§é›†åˆ—è¡¨åŒºåŸŸ -->
                <div class="episode-list">
                    <div id="episodes" class="episodes"></div>
                </div>
            </div>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ (æŒ‰Ctrl+Dæ˜¾ç¤º) -->
        <div class="debug-panel" id="debug-panel"
            style="position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.9); color: white; padding: 15px; border-radius: 8px; font-size: 12px; font-family: 'Courier New', monospace; z-index: 10000; max-width: 400px; display: none; border: 1px solid #444; max-height: 300px; overflow-y: auto;">
            <div style="margin-bottom: 10px; font-weight: bold; color: #4caf50;">ğŸ“Š è°ƒè¯•ä¿¡æ¯</div>
            <div id="debug-content" style="line-height: 1.4;"></div>
            <div style="margin-top: 10px; display: flex; gap: 5px;">
                <button onclick="updateDebugInfo()"
                    style="padding: 4px 8px; font-size: 11px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer;">åˆ·æ–°</button>
                <button onclick="document.getElementById('debug-panel').style.display='none'"
                    style="padding: 4px 8px; font-size: 11px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;">å…³é—­</button>
            </div>
        </div>

        <script>
            // è°ƒè¯•é¢æ¿æ§åˆ¶
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    const debugPanel = document.getElementById('debug-panel');
                    debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
                    if (debugPanel.style.display === 'block') {
                        updateDebugInfo();
                    }
                }
            });

            function updateDebugInfo() {
                const debugContent = document.getElementById('debug-content');
                if (!debugContent) return;

                const info = [];

                // æ£€æŸ¥Electron API
                info.push('ğŸ”§ <strong>Electron API çŠ¶æ€:</strong>');
                info.push(`window.electron: ${window.electron ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`);
                if (window.electron) {
                    info.push(`window.electron.window: ${window.electron.window ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`);
                    info.push(`toggleAlwaysOnTop: ${window.electron.window?.toggleAlwaysOnTop ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`);
                    info.push(`clipboard: ${window.electron.clipboard ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`);
                }

                info.push('');
                info.push('ğŸ“¹ <strong>æ’­æ”¾å™¨çŠ¶æ€:</strong>');
                const player = window.videoPlayer;
                if (player) {
                    info.push(`videoData: ${player.videoData ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`);
                    if (player.videoData) {
                        info.push(`- å½±ç‰‡: ${player.videoData.vod_name || 'æœªçŸ¥'}`);
                        info.push(`- ID: ${player.videoData.vod_id || 'æœªçŸ¥'}`);
                        info.push(`- ç«™ç‚¹: ${player.videoData.siteName || player.videoData.site_name || 'æœªçŸ¥'}`);
                        info.push(`- URL: ${player.videoData.siteUrl || player.videoData.site_url || 'æœªçŸ¥'}`);
                    }
                    info.push(`isCasting: ${player.isCasting ? 'âœ… æ­£åœ¨æŠ•å±' : 'âŒ æœªæŠ•å±'}`);
                } else {
                    info.push('æ’­æ”¾å™¨å®ä¾‹: âŒ æœªåˆ›å»º');
                }

                info.push('');
                info.push('ğŸŒ <strong>æµè§ˆå™¨ API:</strong>');
                info.push(`navigator.clipboard: ${navigator.clipboard ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}`);
                info.push(`navigator.presentation: ${navigator.presentation ? 'âœ… æ”¯æŒæŠ•å±' : 'âŒ ä¸æ”¯æŒæŠ•å±'}`);

                info.push('');
                info.push('ğŸ›ï¸ <strong>æŒ‰é’®å…ƒç´ çŠ¶æ€:</strong>');
                const buttons = [
                    { id: 'toggle-always-on-top', name: 'ç½®é¡¶æŒ‰é’®' },
                    { id: 'share-video', name: 'åˆ†äº«æŒ‰é’®' },
                    { id: 'cast-video', name: 'æŠ•å±æŒ‰é’®' }
                ];
                buttons.forEach(btn => {
                    const element = document.getElementById(btn.id);
                    info.push(`${btn.name}: ${element ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);
                    if (element) {
                        const style = window.getComputedStyle(element);
                        info.push(`- å¯è§æ€§: ${style.visibility !== 'hidden' && style.opacity !== '0' ? 'âœ…' : 'âŒ'}`);
                        info.push(`- ç‚¹å‡»äº‹ä»¶: ${element.onclick || element.onmousedown ? 'âœ…' : 'â“'}`);
                    }
                });

                debugContent.innerHTML = info.join('<br>');
            }
        </script>

    </div> <!-- å…³é—­ player-app -->

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="js/storage.js"></script>
    <script src="js/danmaku.js"></script>
    <script src="js/enhanced-danmaku.js"></script>
    <script src="js/player.js"></script>

    <!-- åˆå§‹åŒ–æ’­æ”¾å™¨ -->
    <script>
        // ç¡®ä¿DOMå®Œå…¨åŠ è½½ååˆå§‹åŒ–æ’­æ”¾å™¨
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸŒŸğŸŒŸğŸŒŸ [PLAYER] DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ’­æ”¾å™¨ ğŸŒŸğŸŒŸğŸŒŸ');

            // ä¸ºé‡è¯•æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
            const retryBtn = document.getElementById('retry-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', () => {
                    if (window.videoPlayer && window.videoPlayer.retryVideo) {
                        window.videoPlayer.retryVideo();
                    } else {
                        console.error('æ’­æ”¾å™¨å®ä¾‹æœªåˆå§‹åŒ–ï¼Œæ— æ³•é‡è¯•');
                    }
                });
            }

            // ç«‹å³æµ‹è¯•å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
            console.log('ğŸ” [PLAYER-TEST] å¼€å§‹æ£€æŸ¥å…³é”®DOMå…ƒç´ ...');
            const testElements = [
                'video-player',
                'play-pause-btn',
                'player-overlay',
                'toggle-always-on-top',
                'share-video',
                'cast-video'
            ];

            testElements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`[PLAYER-TEST] ${id}: ${element ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°'}`);
                if (element) {
                    console.log(`[PLAYER-TEST] ${id} è¯¦æƒ…:`, {
                        tagName: element.tagName,
                        className: element.className,
                        style: element.style.cssText || 'æ— å†…è”æ ·å¼',
                        visible: element.offsetParent !== null
                    });
                }
            });

            console.log('ğŸ” [PLAYER-TEST] DOMå…ƒç´ æ£€æŸ¥å®Œæˆ');

            try {
                window.videoPlayer = new VideoPlayer();
                window.videoPlayer.initialize();
                console.log('[PLAYER] æ’­æ”¾å™¨å®ä¾‹åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                console.error('[PLAYER] æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
    </script>
</body>

</html>